generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   ENUMS
========================= */

enum UserRole {
  CUSTOMER
  STORE_MANAGER
  ADMIN
}

enum VisitStatus {
  SCHEDULED
  COMPLETED
  MISSED
  CANCELLED
}

enum StoreItemCategory {
  CLOTHING
  FOOTWEAR
  ACCESSORIES
  JEWELRY
  BEAUTY
  HOME
  ELECTRONICS
  FOOD
  OTHER
}

enum StoreImageType {
  LOGO
  STOREFRONT
  GALLERY
}

enum ImageStatus {
  ACTIVE
  ARCHIVED
}

enum DiscountType {
  PERCENTAGE
  AMOUNT
  FREE_SHIPPING
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

/* =========================
   USER
========================= */

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String?
  emailVerified DateTime?
  role          UserRole @default(CUSTOMER)

  // Phone
  phoneCountry String?
  phoneArea    String?
  phoneNumber  String?

  // Address
  city    String?
  state   String?
  zip     String?
  country String?

  // Optional profile
  age        Int?
  gender     String?
  heightCm   Int?
  weightKg   Int?
  occupation String?
  avatarUrl  String?

  // Relations
  storesManaged    Store[]
  visits           Visit[]
  accounts         Account[]
  sessions         Session[]
  notifications    Notification[]
  favorites        Favorite[]
  reviews          Review[]
  orders           Order[]
  auditLogs        AuditLog[]

  // Tokens
  verificationToken         String?   @unique
  verificationTokenExpires  DateTime?
  resetPasswordToken        String?   @unique
  resetPasswordTokenExpires DateTime?

  // Preferences
  preferredCurrency String?   @default("EUR")
  language          String?   @default("en")
  marketingOptIn    Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
}

/* =========================
   STORE
========================= */

model Store {
  id        String   @id @default(cuid())
  managerId String @unique

  // Basic Info
  name        String
  description String?
  email       String?   @unique
  website     String?
  logoUrl      String?
  storefrontUrl String?

  // Contact
  phoneCountry String?
  phoneArea    String?
  phoneNumber  String?
  supportEmail String?

  // Address
  country      String
  city         String
  state        String
  zip          String
  street       String
  streetNumber String
  floor        String?
  apartment    String?
  latitude     Float?
  longitude    Float?

  // Business Info
  acceptedCurrencies String[] @default(["EUR"])
  categories         String[]
  tags               String[]
  isActive           Boolean  @default(true)
  isVerified         Boolean  @default(false)
  rating             Float?   @default(0)
  totalReviews       Int      @default(0)

  // Hours
  openingHours Json?
  holidays     DateTime[]

  // Social Media
  facebookUrl  String?
  instagramUrl String?
  twitterUrl   String?
  youtubeUrl   String?
  tiktokUrl    String?

  // Relations
  manager         User                 @relation(fields: [managerId], references: [id], onDelete: Cascade)
  visits          Visit[]
  discounts       Discount[]
  items           StoreItem[]
  images          StoreImage[]
  weeklyDiscounts StoreWeeklyDiscount[]
  reviews         Review[]
  favorites       Favorite[]
  notifications   StoreNotification[]
  orders          Order[]
  analytics       StoreAnalytics[]
  auditLogs       AuditLog[]

  // Analytics
  totalVisits     Int      @default(0)
  totalCustomers  Int      @default(0)
  totalSales      Float    @default(0)
  monthlyVisits   Json?    // Stores monthly visit counts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([managerId])
  @@index([city])
  @@index([country])
}

/* =========================
   STORE IMAGES (LOGO / GALLERY)
========================= */

model StoreImage {
  id          String        @id @default(cuid())
  storeId     String

  // Image Info
  imageUrl    String
  thumbnailUrl String?
  type        StoreImageType
  title       String?
  description String?
  altText     String?
  order       Int           @default(0)
  status      ImageStatus   @default(ACTIVE)

  // Metadata
  fileSize    Int?          // in bytes
  width       Int?
  height      Int?
  mimeType    String?
  
  // Relations
  store       Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([storeId, type])
  @@index([storeId, order])
}

/* =========================
   STORE WEEKLY DISCOUNTS
========================= */

model StoreWeeklyDiscount {
  id        String     @id @default(cuid())
  storeId   String

  // Timing
  dayOfWeek DayOfWeek
  startTime String     // HH:mm
  endTime   String     // HH:mm

  // Discount
  type      DiscountType @default(PERCENTAGE)
  value     Float        // percentage or amount
  minPurchase Float?     // Minimum purchase required
  maxDiscount Float?     // Maximum discount amount
  code      String?      // Optional discount code

  // Restrictions
  applicableCategories String[]  // Which categories this applies to
  excludedItems       String[]   // Item IDs that are excluded
  isActive           Boolean     @default(true)

  // Usage
  maxUses            Int?        // Per customer
  totalUses          Int         @default(0)

  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, dayOfWeek, startTime, endTime])
  @@index([storeId])
  @@index([storeId, isActive])
}

/* =========================
   STORE ITEMS
========================= */

model StoreItem {
  id          String   @id @default(cuid())
  storeId     String

  // Item Info
  name        String
  sku         String?   @unique
  category    StoreItemCategory
  subcategory String?
  description String?
  brand       String?
  color       String?
  size        String?

  // Pricing
  price           Int?       // in cents
  comparePrice    Int?       // original price in cents
  costPrice       Int?       // in cents
  currency        String     @default("EUR")
  isTaxIncluded   Boolean    @default(true)
  taxRate         Float?     @default(0)

  // Inventory
  stockQuantity   Int        @default(0)
  lowStockThreshold Int?     @default(10)
  isInStock       Boolean    @default(true)
  allowBackorder  Boolean    @default(false)
  weight          Float?     // in kg
  dimensions      Json?      // {length, width, height}

  // Visibility
  visible        Boolean     @default(true)
  featured       Boolean     @default(false)
  isNew          Boolean     @default(false)
  isOnSale       Boolean     @default(false)

  // Relations
  store      Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  images     StoreItemImage[]
  discounts  StoreItemDiscount[]
  favorites  Favorite[]
  orderItems OrderItem[]

  // Stats
  views      Int             @default(0)
  purchases  Int             @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([storeId, category])
  @@index([storeId, featured])
  @@index([storeId, isOnSale])
}

model StoreItemImage {
  id          String    @id @default(cuid())
  storeItemId String

  imageUrl    String
  thumbnailUrl String?
  order       Int       @default(0)
  altText     String?
  caption     String?

  storeItem   StoreItem @relation(fields: [storeItemId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([storeItemId])
  @@index([storeItemId, order])
}

model StoreItemDiscount {
  id          String       @id @default(cuid())
  storeItemId String
  discountId  String

  storeItem   StoreItem    @relation(fields: [storeItemId], references: [id], onDelete: Cascade)
  discount    Discount     @relation(fields: [discountId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([storeItemId, discountId])
}

/* =========================
   VISIT
========================= */

model Visit {
  id          String     @id @default(cuid())
  userId      String
  storeId     String
  discountId  String?

  // Scheduling
  scheduledDate   DateTime
  scheduledTime   String      // HH:mm
  scheduledEnd    DateTime?   // End time if duration is known
  duration        Int?        // in minutes
  notes           String?

  // Visit Details
  actualStart     DateTime?
  actualEnd       DateTime?
  checkedIn       Boolean     @default(false)
  checkedInAt     DateTime?
  status          VisitStatus @default(SCHEDULED)

  // Discount Tracking
  discountUnlocked Boolean   @default(false)
  discountUsed     Boolean   @default(false)
  discountCode     String?
  discountAmount   Float?
  discountPercent  Float?

  // Customer Details
  customerNotes   String?
  specialRequests String?
  numberOfPeople  Int        @default(1)

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  discount Discount? @relation(fields: [discountId], references: [id])
  review   Review?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([userId])
  @@index([scheduledDate])
  @@index([status])
  @@index([storeId, scheduledDate])
}

/* =========================
   DISCOUNT (EVENT / VISIT BASED)
========================= */

model Discount {
  id      String       @id @default(cuid())
  storeId String

  // Basic Info
  title           String
  description     String?
  code            String?     @unique
  type            DiscountType @default(PERCENTAGE)

  // Discount Value
  discountPercent Float?
  discountAmount  Float?
  minPurchase     Float?     // Minimum purchase required
  maxDiscount     Float?     // Maximum discount amount

  // Validity
  validFrom       DateTime?
  validTo         DateTime?
  isActive        Boolean     @default(true)

  // Usage Limits
  maxUses         Int?        // Total max uses
  currentUses     Int         @default(0)
  maxUsesPerUser  Int?        @default(1)
  isSingleUse     Boolean     @default(false)

  // Restrictions
  applicableCategories String[]
  excludedItems       String[]
  svdOnly            Boolean   @default(false) // Scheduled Visit Discount
  isPublic           Boolean   @default(true)
  isStackable        Boolean   @default(false)

  // Relations
  store    Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  visits   Visit[]
  items    StoreItemDiscount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([code])
  @@index([validFrom, validTo])
  @@index([storeId, isActive])
}

/* =========================
   REVIEWS & RATINGS
========================= */

model Review {
  id        String   @id @default(cuid())
  userId    String
  storeId   String
  visitId   String?   @unique

  rating    Int      // 1-5
  title     String?
  comment   String?
  images    String[] // Array of image URLs

  // Response
  ownerReply      String?
  ownerReplyDate  DateTime?

  // Metadata
  isVerified  Boolean  @default(false) // Verified purchase
  isHelpful   Int      @default(0)     // Helpful votes
  isReported  Boolean  @default(false)

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  visit Visit? @relation(fields: [visitId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([userId])
  @@index([storeId, rating])
  @@unique([userId, storeId, visitId])
}

/* =========================
   FAVORITES
========================= */

model Favorite {
  id        String    @id @default(cuid())
  userId    String
  storeId   String?
  itemId    String?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  store     Store?    @relation(fields: [storeId], references: [id])
  item      StoreItem? @relation(fields: [itemId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, storeId, itemId])
  @@index([userId])
  @@index([storeId])
  @@index([itemId])
}

/* =========================
   NOTIFICATIONS
========================= */

model Notification {
  id        String   @id @default(cuid())
  userId    String

  title     String
  message   String
  type      String   // visit, discount, system, etc.
  isRead    Boolean  @default(false)
  data      Json?    // Additional data
  actionUrl String?  // URL to navigate to

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, isRead])
}

model StoreNotification {
  id        String   @id @default(cuid())
  storeId   String

  title     String
  message   String
  type      String   // new_visit, low_stock, review, etc.
  isRead    Boolean  @default(false)
  data      Json?
  actionUrl String?

  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([storeId])
  @@index([storeId, isRead])
}

/* =========================
   ORDERS (Optional for future e-commerce)
========================= */

model Order {
  id              String     @id @default(cuid())
  userId          String
  storeId         String

  orderNumber     String     @unique
  status          String     @default("pending") // pending, confirmed, processing, shipped, delivered, cancelled
  paymentStatus   String     @default("pending") // pending, paid, failed, refunded
  paymentMethod   String?

  subtotal        Int        // in cents
  tax             Int        // in cents
  shipping        Int        // in cents
  discount        Int        // in cents
  total           Int        // in cents
  currency        String     @default("EUR")

  shippingAddress Json?
  billingAddress  Json?

  notes           String?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  store           Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items           OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([storeId])
  @@index([orderNumber])
  @@index([status])
}

model OrderItem {
  id        String    @id @default(cuid())
  orderId   String
  itemId    String

  quantity  Int
  price     Int       // in cents at time of purchase
  subtotal  Int       // quantity * price

  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  item      StoreItem @relation(fields: [itemId], references: [id])

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([itemId])
}

/* =========================
   ANALYTICS
========================= */

model StoreAnalytics {
  id        String   @id @default(cuid())
  storeId   String
  date      DateTime

  // Visit Stats
  visitsScheduled Int @default(0)
  visitsCompleted Int @default(0)
  visitsCancelled Int @default(0)

  // Customer Stats
  newCustomers   Int @default(0)
  returningCustomers Int @default(0)

  // Sales Stats
  totalRevenue   Float @default(0)
  averageOrderValue Float @default(0)
  conversionRate Float @default(0)

  // Discount Stats
  discountsClaimed Int @default(0)
  discountsUsed    Int @default(0)

  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([storeId, date])
  @@index([storeId])
  @@index([date])
}

/* =========================
   AUTH (NextAuth)
========================= */

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/* =========================
   AUDIT LOG
========================= */

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  storeId   String?

  action    String   // created, updated, deleted, etc.
  entity    String   // User, Store, Visit, etc.
  entityId  String?
  changes   Json?    // Before/after changes
  ipAddress String?
  userAgent String?

  user      User?    @relation(fields: [userId], references: [id])
  store     Store?   @relation(fields: [storeId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([storeId])
  @@index([entity, entityId])
  @@index([createdAt])
}